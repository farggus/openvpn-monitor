# План исправления проблем парсера и API

## Общий подход
Чтобы минимизировать регрессии и облегчить ревью, работу лучше разбить на независимые этапы. Каждый шаг закрывает одну или группу близких задач и сопровождается тестами/ручной проверкой. Если команда настаивает на одном PR, секция «Один большой PR» описывает порядок выполнения внутри единственной ветки, но стоит учесть риск громоздкого обзора и сложного отката.

## Последовательные шаги
1. **Конфигурируемость и подготовка окружения**
   - Вынести таймзону, пути к логам и прочие константы парсера в `config.py` и/или переменные окружения.
   - Добавить в README примеры переменных окружения.
   - Обновить парсер и фоновые процессы на использование конфигурации.
2. **Улучшение надёжности файлового хранилища**
   - Реализовать атомарную запись `active_sessions.json` (через временные файлы + `os.replace`).
   - Добавить блокировки или переход на файловую БД (SQLite) для истории.
   - Ввести валидацию структуры при чтении JSON.
3. **Оптимизация парсера**
   - Переписать `parse_status_log` на потоковую обработку файла с единичным проходом.
   - Нормализовать работу с IPv6 (хранить порт или пустую строку).
   - Перевести `print` на `logging` с понятными уровнями.
4. **API и фоновые задачи**
   - Убрать dev-флаги (`DEBUG`, `PROPAGATE_EXCEPTIONS`) из продакшн-конфига.
   - В `/api/server-status` повторно использовать результаты парсинга клиентов (кэш на время запроса или внедрение слоя службы).
   - Смягчить фильтр истории, чтобы строки без RX/TX обрабатывались корректно.
   - Для ошибок API возвращать структурированные ответы и логировать исключения.
5. **Тестирование и наблюдаемость**
   - Написать юнит-тесты на кейсы IPv6, reconnection, повреждённые данные.
   - Добавить линтер/форматтер и базовый CI (GitHub Actions).
   - Задокументировать команды для локальной проверки.

## Один большой PR
Если нужно закрыть всё сразу, придерживайтесь порядка из раздела выше, но объедините коммиты:
1. Конфигурация и рефакторинг парсера.
2. Надёжная работа с файлами и улучшенный логгинг.
3. Изменения API и фронтенда, завязанные на новые данные.
4. Финальные тесты и документация.

Важно в описании PR явно перечислить рискованные изменения и сценарии тестирования, иначе ревью может затянуться.
